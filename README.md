# SPCS Restricted Callers Rights Lab

This repository contains a comprehensive hands-on lab for Snowflake Solution Engineers to learn and demonstrate SPCS (Snowpark Container Services) Restricted Callers Rights functionality.

## Lab Overview

**Target Audience:** Snowflake Solution Engineers  
**Duration:** 90 minutes  
**Difficulty:** Intermediate  
**Industry Focus:** Financial Services (Multi-tenant SaaS Platform)

## Learning Objectives

- Master SPCS Restricted Callers Rights configuration and implementation
- Understand multi-tenant security patterns with Snowflake
- Learn effective discovery questions and value proposition messaging
- Practice objection handling for container security scenarios
- Demonstrate ROI calculation for enterprise customers

## Repository Structure

```
├── SPCS_Restricted_Callers_Rights_HOL.docx   # Main lab document
├── analytics-service/                         # Container application
│   ├── app.py                                # Flask analytics service
│   ├── Dockerfile                            # Container build config
│   └── requirements.txt                      # Python dependencies
├── sql-setup/                                # Database setup scripts
│   ├── 01_initial_setup.sql                 # Environment setup
│   ├── 02_data_setup.sql                    # Sample data creation
│   └── 03_security_setup.sql                # Security configuration
├── service-configs/                          # SPCS configurations
│   └── analytics-service.yaml               # Service specification
├── grading-scripts/                          # DORA automated grading
│   └── dora_lab_validation.sql              # Validation and scoring
├── build-scripts/                           # Automation scripts
│   └── build_and_deploy.sh                  # Build/deploy automation
└── README.md                                # This file
```

## Prerequisites

### Software Requirements
- Snowflake account with SPCS enabled
- Docker Desktop installed and running
- SnowSQL CLI configured
- Access to Demo83 environment (or equivalent)

### Knowledge Prerequisites
- Basic understanding of Snowpark Container Services
- Familiarity with SQL and Docker concepts
- Understanding of multi-tenant application architectures

## Quick Start Guide

### 1. Environment Setup

```bash
# Clone or download this repository
git clone <repository-url>
cd spcs-restricted-callers-rights-lab

# Make scripts executable
chmod +x build-scripts/build_and_deploy.sh
```

### 2. Snowflake Environment Setup

Execute the setup scripts in order:

```sql
-- Run in SnowSQL or Snowsight
snowsql -f sql-setup/01_initial_setup.sql
snowsql -f sql-setup/02_data_setup.sql  
snowsql -f sql-setup/03_security_setup.sql
```

### 3. Container Build and Deployment

```bash
# Build and deploy everything
./build-scripts/build_and_deploy.sh all

# Or run individual steps
./build-scripts/build_and_deploy.sh build
./build-scripts/build_and_deploy.sh push
./build-scripts/build_and_deploy.sh deploy
```

### 4. Service Deployment

```sql
-- Upload service specification
PUT file://service-configs/analytics-service.yaml @internal_stage;

-- Deploy the service (generated by build script)
snowsql -f deploy_service.sql
```

### 5. Validation

```sql
-- Run validation tests
snowsql -f validate_deployment.sql
```

## Lab Components Explained

### Analytics Service Application

The `analytics-service/` directory contains a Flask-based web application that demonstrates:
- **Caller's Rights Authentication:** Uses `Sf-Context-Current-User-Token` header
- **Multi-tenant Data Access:** Automatic user-based data filtering
- **RESTful API Design:** Clean endpoints for financial analytics
- **Security Validation:** Built-in testing endpoints

Key endpoints:
- `GET /health` - Health check
- `GET /api/client-summary/<client_id>` - Transaction summary
- `GET /api/transactions/<client_id>` - Detailed transactions
- `GET /api/security-test` - Security configuration validation

### Security Configuration

The lab implements multiple layers of security:

1. **Caller Grants:** Define what user privileges the service can access
2. **Row Access Policies:** Ensure data isolation between tenants
3. **Dynamic Data Masking:** Protect sensitive account information
4. **Service Roles:** Control access to service endpoints

### Sample Data

The lab uses realistic financial transaction data:
- **Client A:** Financial services company transactions
- **Client B:** Regional bank transactions
- **Multi-tenant Structure:** Separate data per client with shared application

## Business Context and Use Cases

### Customer Profile: SecureFinance Analytics
- **Industry:** FinTech
- **Challenge:** Multi-tenant analytics platform
- **Requirements:** Strict data isolation, compliance (SOX, PCI DSS)
- **Solution:** SPCS Restricted Callers Rights for secure multi-tenancy

### Ideal Customer Indicators
- Multi-tenant SaaS applications
- Strict compliance requirements
- Container-based architecture (current or planned)
- Need for data-level access controls

### Key Value Propositions
1. **Enhanced Security:** User-level access controls at container level
2. **Simplified Multi-tenancy:** Single app, automatic data isolation
3. **Compliance Ready:** Built-in audit trails and access controls
4. **Operational Efficiency:** Reduced infrastructure complexity

## Sales Enablement Resources

### Discovery Questions
- Security & Compliance focus
- Technical Architecture assessment
- Business Impact evaluation

### Objection Handling
- "We have Kubernetes RBAC" → Data-level vs infrastructure-level security
- "Seems complex" → Compare to current multi-tenant approach
- "Performance concerns" → Minimal impact, network latency reduction
- "Not ready for containers" → Future-ready positioning

### Competitive Positioning
- **vs. AWS EKS/ECS:** Native Snowflake integration
- **vs. Azure AKS:** Data-native security model
- **vs. Custom solutions:** Fully managed, immediate availability

## DORA Automated Grading

The lab includes comprehensive automated grading:

### Grading Categories (100 points total)
1. **Infrastructure Setup (20 points):** Basic environment configuration
2. **Data Setup (15 points):** Sample data and schema creation
3. **Security Configuration (25 points):** Caller grants and policies
4. **Container Service (20 points):** SPCS deployment and configuration
5. **Data Isolation (15 points):** Multi-tenant security validation
6. **Business Understanding (5 points):** Operational awareness

### Running the Grader

```sql
-- Execute grading for a student
CALL SPCS_RESTRICTED_DEMO.GRADING.grade_spcs_lab('student.email@company.com');

-- View results
SELECT * FROM SPCS_RESTRICTED_DEMO.GRADING.lab_grading_summary 
WHERE student_id = 'student.email@company.com';
```

### Grading Scale
- **90-100%:** A (Excellent)
- **80-89%:** B (Good)
- **70-79%:** C (Satisfactory)
- **60-69%:** D (Needs Improvement)
- **<60%:** F (Unsatisfactory)

**Passing Grade:** 70% (C or above)

## Troubleshooting

### Common Issues

**Container build fails:**
- Ensure Docker is running
- Check network connectivity
- Verify file permissions

**Service deployment fails:**
- Verify compute pool is active
- Check caller grants configuration
- Ensure image is pushed to registry

**Data access issues:**
- Verify row access policies are applied
- Check role assignments
- Validate caller grants

**Authentication problems:**
- Confirm `executeAsCaller: true` in service spec
- Check `Sf-Context-Current-User-Token` header
- Verify service role grants

### Debug Commands

```sql
-- Check service status
SHOW SERVICES;
DESCRIBE SERVICE analytics_service;

-- Verify security configuration
SHOW CALLER GRANTS TO ROLE PLATFORM_OWNER;
SHOW ROW ACCESS POLICIES;

-- Test data access
USE ROLE CLIENT_A_ANALYST;
SELECT COUNT(*) FROM client_transactions;

-- Monitor query history
SELECT * FROM SPCS_RESTRICTED_DEMO.FINANCIAL_DATA.security_audit_log 
ORDER BY start_time DESC LIMIT 10;
```

## Advanced Configurations

### Additional Security Layers

```sql
-- Time-based access controls
CREATE ROW ACCESS POLICY time_based_access AS (
    transaction_date >= DATEADD(days, -30, CURRENT_DATE())
);

-- Column-level encryption
ALTER TABLE client_transactions 
MODIFY COLUMN description SET ENCRYPTION POLICY sensitive_data_policy;
```

### Performance Optimization

```sql
-- Create materialized views for common queries
CREATE MATERIALIZED VIEW client_summary_mv AS
SELECT client_id, SUM(amount) as total_amount
FROM client_transactions
GROUP BY client_id;

-- Add clustering keys for better performance
ALTER TABLE client_transactions CLUSTER BY (client_id, transaction_date);
```

### Monitoring and Alerting

```sql
-- Create alerts for security violations
CREATE ALERT security_violation_alert
WAREHOUSE = SPCS_LAB_WH
SCHEDULE = '1 MINUTE'
IF (SELECT COUNT(*) FROM security_audit_log 
    WHERE start_time > DATEADD(minute, -1, CURRENT_TIMESTAMP()) 
    AND execution_status = 'FAIL') > 0
THEN CALL send_security_alert();
```

## Lab Extensions

### Additional Exercises
1. **Multi-region Deployment:** Configure SPCS across multiple regions
2. **Advanced Security:** Implement field-level encryption
3. **Performance Testing:** Load testing with multiple concurrent users
4. **Compliance Reporting:** Build automated compliance dashboards

### Industry Variations
- **Healthcare:** PHI data protection scenarios
- **Government:** FedRAMP compliance requirements
- **Retail:** PCI DSS implementation patterns

## Support and Resources

### Documentation Links
- [SPCS Security Best Practices](https://docs.snowflake.com/spcs-security)
- [Caller Grants Reference](https://docs.snowflake.com/caller-grants)
- [Container Services Tutorial](https://docs.snowflake.com/spcs-tutorial)

### Training Resources
- Snowflake University: Container Services Fundamentals
- Partner Training: Security Architecture with Snowflake
- Certification: Snowflake Security Specialist

### Getting Help
- Solution Engineering team for POC assistance
- Professional Services for implementation guidance
- Customer Support for operational issues

## Contributing

To contribute improvements to this lab:

1. Fork the repository
2. Create a feature branch
3. Test changes thoroughly
4. Submit a pull request with detailed description

### Feedback

Please provide feedback on:
- Lab clarity and difficulty level
- Technical accuracy
- Sales enablement effectiveness
- Grading rubric fairness

Contact: SE-Uni-Team@snowflake.com

---

**Lab Version:** 1.0  
**Last Updated:** January 2024  
**Maintained by:** Snowflake Solution Engineering University Team 